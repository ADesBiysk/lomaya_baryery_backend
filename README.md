# lomaya_baryery_backend
# Бэкенд проекта "Ломая барьеры"

## Настройка poetry <a id="poetry"></a>:

Poetry - это инструмент для управления зависимостями и виртуальными
окружениями,
также может использоваться для сборки пакетов.

В этом проекте Poetry необходим для дальнейшей разработки приложения.

### Установка:

Установите poetry следуя [инструкции с официального сайта](https://python-poetry.org/docs/#installation).

После установки перезапустите оболочку и введите команду

> poetry --version

Если установка прошла успешно, вы получите ответ в формате

> Poetry version 1.1.13


Для дальнейшей работы введите команду:

> poetry config virtualenvs.in-project true

Выполнение данной команды необходимо для создания виртуального окружения в
папке проекта.

После предыдущей команды создадим виртуальное окружение нашего проекта с
помощью команды

> poetry install

Результатом выполнения команды станет создание в корне проекта папки .venv.
Зависимости для создания окружения берутся из файлов poetry.lock (приоритетнее)
и pyproject.toml

Для добавления новой зависимости в окружение необходимо выполнить команду

> poetry add <package_name>

_Пример использования:_

> poetry add starlette

Также poetry позволяет разделять зависимости необходимые для разработки, от
основных.
Для добавления зависимости необходимой для разработки и тестирования необходимо
добавить флаг ***--dev***

> poetry add <package_name> --dev

_Пример использования:_

> poetry add pytest --dev


### Порядок работы после настройки

Чтобы активировать виртуальное окружение введите команду:

> poetry shell

Существует возможность запуска скриптов и команд с помощью команды без
активации окружения:

> poetry run <script_name>.py


_Примеры:_

> poetry run python script_name>.py
>
> poetry run pytest
>
> poetry run black

Порядок работы в оболочке не меняется. Пример команды для Win:

> python src\run_bot.py


## Настройка pre-commit <a id="pre-commit"></a>:

> poetry install
>
> pre-commit install

Далее при каждом коммите у вас будет происходить автоматическая проверка
линтером, а так же будет происходить автоматическое приведение к единому стилю.


## Переменные окружения:

```dotenv
DB_NAME=  # имя базы данных
POSTGRES_USER= # логин для подключения к базе данных
POSTGRES_PASSWORD= # пароль для подключения к БД
DB_HOST= # название сервиса (контейнера)
DB_PORT= # порт для подключения к БД
BOT_TOKEN= # токен бота
DATABASE_URL= # строка для подключения к БД
BOT_WEBHOOK_MODE= # запустить бота в режиме webhook(true)|polling(false)
BOT_WEBHOOK_PORT= # порт для запуска встроенного веб-сервера бота
BOT_WEBHOOK_URL= # URL для получения апдейтов в режиме webhook (домен, на котором развернуто приложение)
```


## Выбор режима работы бота
Возможен запуск бота в режимах `polling` или `webhook`.<br/>

### Polling
Для запуска бота в режиме `polling` нужно установить переменной окружения `BOT_WEBHOOK_MODE` значение `false`. Дополнительных настроек не требуется.

### Webhook
Для запуска бота в режиме `webhook` нужно установить переменной окружения `BOT_WEBHOOK_MODE` значение `true`.<br/>
Работа бота в режиме `webhook` подразумевает получение сообщений (обновлений) от серверов Telegram на публичный IP-адрес или доменное имя сервера, на котором развернуто приложение. При этом соединение должно быть зашифровано по `HTTPS` с использованием `SSL`.<br/>
Домен, к которому будут обращаться серверы Telegram устанавливается в переменной окружения `BOT_WEBHOOK_URL`, например:
```
BOT_WEBHOOK_URL=https://example.com
```
Также, в переменной `BOT_WEBHOOK_PORT` необходимо выбрать порт, на котором будет запущен webhook-сервер:
```
BOT_WEBHOOK_PORT=8443
```
В настоящий момент, телеграм поддерживает 4 порта для вебхуков: 443, 80, 88, 8443.<br/>
В случае отсутствия сервера с доменным именем и установленным SSL-сертификатом, для отладки приложения можно воспользоваться сервисом, предоставлющим возможность построения туннеля до вашего компьютера. Например <a href="https://ngrok.com/">ngrok</a>.<br/>
В этом случае приложение запускается локально, а в качестве доменного имени используется адрес, предоставленный сервисом ngrok.


## Запуск одного бота:

```shell
python run_bot.py
```


## Запустить проект локально:

```shell
python run.py
```

## Запуск docker-compose:

```shell
docker-compose up
```

### Проект доступен по следующим адресам:

```
http://127.0.0.1:8080
http://0.0.0.0:8080
http://localhost:8080
```

## API endpoints:

- **GET**```/hello```: Получить сообщение "hello world!"

### response

```json
{
  "answer": "hello world!"
}
```

## Comands for Bot:

- ```/start```: Запустить бота и получить приветственное сообщение

```text
Это бот Центра "Ломая барьеры", который в игровой форме поможет 
особенному ребенку стать немного самостоятельнее! 
Выполняя задания каждый день, ребенку будут начислять виртуальные 
"ломбарьерчики". Каждый месяц мы будем подводить итоги и 
награждать самых активных и старательных ребят! 
```